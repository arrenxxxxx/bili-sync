name: Build and Push Docker Image

on:
  push:
    tags:
      - v*
  workflow_dispatch:
    inputs:
      custom_tags:
        description: '自定义镜像标签 (用逗号分隔多个标签，例如: v2.0.0,latest)'
        required: false
        default: ''
        type: string

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/bili-sync

jobs:
  # 构建二进制文件
  build-binaries:
    name: Build Linux Binaries
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-musl
            name: Linux-x86_64-musl
            archive_name: bili-sync-rs-Linux-x86_64-musl.tar.gz
          - target: aarch64-unknown-linux-musl
            name: Linux-aarch64-musl
            archive_name: bili-sync-rs-Linux-aarch64-musl.tar.gz

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: latest

    - name: Install frontend dependencies
      run: |
        cd web
        bun install --frozen-lockfile

    - name: Build frontend
      run: |
        cd web
        bun run build

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@v2
      with:
        key: ${{ matrix.target }}

    - name: Install cross (for Linux ARM64)
      if: matrix.target == 'aarch64-unknown-linux-musl'
      run: cargo install cross --git https://github.com/cross-rs/cross

    - name: Install musl tools (for Linux x86_64)
      if: matrix.target == 'x86_64-unknown-linux-musl'
      run: |
        sudo apt-get update
        sudo apt-get install -y musl-tools

    - name: Build binary
      run: |
        if [ "${{ matrix.target }}" = "aarch64-unknown-linux-musl" ]; then
          cross build --release --target ${{ matrix.target }}
        else
          cargo build --release --target ${{ matrix.target }}
        fi

    - name: Prepare binary
      run: |
        mkdir -p release
        cp target/${{ matrix.target }}/release/bili-sync-rs release/bili-sync-rs

    - name: Create release archive
      run: |
        cd release
        tar -czf ${{ matrix.archive_name }} bili-sync-rs

    - name: Upload binary archive
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.archive_name }}
        path: release/${{ matrix.archive_name }}

  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: build-binaries

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download Linux x86_64 binary
      uses: actions/download-artifact@v4
      with:
        name: bili-sync-rs-Linux-x86_64-musl.tar.gz
        path: ./

    - name: Download Linux ARM64 binary
      uses: actions/download-artifact@v4
      with:
        name: bili-sync-rs-Linux-aarch64-musl.tar.gz
        path: ./

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Prepare Docker tags
      id: tags
      run: |
        DOCKERHUB_TAGS="${{ env.IMAGE_NAME }}:latest"

        # 使用 tag 名称作为版本标签
        if [[ "${{ github.ref_type }}" == "tag" ]]; then
          TAG_NAME="${{ github.ref_name }}"
          DOCKERHUB_TAGS="$DOCKERHUB_TAGS,${{ env.IMAGE_NAME }}:$TAG_NAME"
        fi

        # 手动触发时的自定义标签
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] && [[ -n "${{ github.event.inputs.custom_tags }}" ]]; then
          IFS=',' read -ra CUSTOM_TAGS <<< "${{ github.event.inputs.custom_tags }}"
          for tag in "${CUSTOM_TAGS[@]}"; do
            tag=$(echo "$tag" | xargs)
            DOCKERHUB_TAGS="$DOCKERHUB_TAGS,${{ env.IMAGE_NAME }}:$tag"
          done
        fi

        echo "dockerhub_tags=$DOCKERHUB_TAGS" >> $GITHUB_OUTPUT
        echo "推送到 Docker Hub 的标签: $DOCKERHUB_TAGS"

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.IMAGE_NAME }}
        tags: |
          type=raw,value=latest
          type=raw,value=${{ github.ref_name }}
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: Dockerfile
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.tags.outputs.dockerhub_tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha, scope=${{ github.workflow }}
        cache-to: type=gha, scope=${{ github.workflow }}

    - name: Update DockerHub description
      uses: peter-evans/dockerhub-description@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
        repository: ${{ secrets.DOCKERHUB_USERNAME }}/bili-sync
